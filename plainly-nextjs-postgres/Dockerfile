FROM node:22-alpine
WORKDIR /app

ARG NEXT_PUBLIC_PLAINLY_API_KEY
ARG NEXT_PUBLIC_WEBHOOK_PUBLIC_URL
ARG NEXT_PUBLIC_PLAINLY_PROJECT_ID
ENV NEXT_PUBLIC_PLAINLY_API_KEY=${NEXT_PUBLIC_PLAINLY_API_KEY}
ENV NEXT_PUBLIC_WEBHOOK_PUBLIC_URL=${NEXT_PUBLIC_WEBHOOK_PUBLIC_URL}
ENV NEXT_PUBLIC_PLAINLY_PROJECT_ID=${NEXT_PUBLIC_PLAINLY_PROJECT_ID}

COPY package.json pnpm-lock.yaml ./
RUN npm install -g pnpm && pnpm install
COPY . .
RUN pnpm build
EXPOSE 3000

CMD ["sh", "-c", "pnpm prisma migrate deploy && pnpm start"]
